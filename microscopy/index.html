<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Eyepiece Graticule Calibration</title>

<style>
body {
  font-family: Arial, sans-serif;
  background:#222;
  color:#eee;
  display:flex;
  gap:30px;
  padding:20px;
}

#scope { width:460px; }

#microscope {
  position:relative;
  width:400px;
  height:400px;
  border-radius:50%;
  overflow:hidden;
  background:#ddd;
}

canvas {
  position:absolute;
  top:0; left:0;
  width:100%; height:100%;
}

.controls button {
  margin:4px;
  padding:6px 10px;
}

.controls button.active {
  border:2px solid #fff;
  font-weight:bold;
}

table { border-collapse:collapse; margin-top:8px; }
td { padding:4px 6px; }
input { width:60px; }

.feedback { font-size:0.85em; }
.wrong { color:#ff6666; }
.correct { color:#66ff99; }
</style>
</head>

<body>

<div id="scope">
  <div id="microscope">
    <canvas id="stage"></canvas>
    <canvas id="graticule"></canvas>
  </div>

  <h3>Stage movement</h3>
  <div class="controls">
    <button onmousedown="startMove(-1,0)">←</button>
    <button onmousedown="startMove(0,-1)">↑</button>
    <button onmousedown="startMove(0,1)">↓</button>
    <button onmousedown="startMove(1,0)">→</button>
  </div>

  <h3>Objective lens</h3>
  <div class="controls" id="objectives"></div>
</div>

<div>
  <h3>Calibration questions</h3>

  <p><strong>At <span id="objLabel"></span> objective lens:</strong></p>

  <table>
    <tr>
      <td>100 stage units (su)</td>
      <td>=</td>
      <td><input id="q1"></td>
      <td>µm</td>
    </tr>
    <tr>
      <td style="padding-left:30px;">1 su</td>
      <td>=</td>
      <td><input id="q2"></td>
      <td>µm</td>
    </tr>
  </table>
  <div id="f12" class="feedback"></div>

  <p><strong>At line of coincidence:</strong></p>

  <table>
    <tr>
      <td><input id="q3"></td>
      <td>eu</td>
      <td>=</td>
      <td><input id="q4"></td>
      <td>su</td>
    </tr>
    <tr>
      <td></td><td></td>
      <td>=</td>
      <td><input id="q5"></td>
      <td>µm</td>
    </tr>
    <tr>
      <td style="padding-left:30px;">1 eu</td>
      <td></td>
      <td>=</td>
      <td><input id="q6"></td>
      <td>µm</td>
    </tr>
  </table>
  <div id="f3456" class="feedback"></div>

  <button onclick="checkAnswers()">Check my answers</button>
</div>

<script>
/* ---------- Canvas ---------- */
const stageCanvas = document.getElementById("stage");
const gratCanvas  = document.getElementById("graticule");
stageCanvas.width = gratCanvas.width = 400;
stageCanvas.height = gratCanvas.height = 400;
const stage = stageCanvas.getContext("2d");
const grat  = gratCanvas.getContext("2d");

/* ---------- Optical model ---------- */
const suPer100eu = { 4:250, 10:100, 40:25, 60:16 };
let objective = 4;

/* ---------- Stage movement ---------- */
let offset = { x:0, y:0 };
const stepX = 6;
const stepY = 3;
let interval=null;

/* ---------- Drawing ---------- */
function drawGraticule(){
  grat.clearRect(0,0,400,400);
  const start=40, end=360, spacing=(end-start)/100;
  for(let i=0;i<=100;i++){
    const x=start+i*spacing;
    const h=i%10===0?26:i%5===0?18:10;
    grat.beginPath();
    grat.moveTo(x,200-h/2);
    grat.lineTo(x,200+h/2);
    grat.strokeStyle="#000";
    grat.stroke();
  }
}

function drawStage(){
  stage.clearRect(0,0,400,400);
  const pxPerSu = 320 / suPer100eu[objective];

  for(let i=0;i<=100;i++){
    const x = 200 + offset.x + (i-50)*pxPerSu;
    const y = 200 + offset.y;
    if(x<-50||x>450) continue;
    const h=i%10===0?34:i%5===0?24:14;
    stage.beginPath();
    stage.moveTo(x,y-h/2);
    stage.lineTo(x,y+h/2);
    stage.strokeStyle="#444";
    stage.stroke();
  }
}

function redraw(){
  drawStage();
  drawGraticule();
  document.getElementById("objLabel").textContent = objective+"×";
}

/* ---------- Movement ---------- */
function startMove(dx,dy){
  move(dx,dy);
  interval=setInterval(()=>move(dx,dy),60);
}
function move(dx,dy){
  offset.x+=dx*stepX;
  offset.y+=dy*stepY;
  offset.x=Math.max(-300,Math.min(300,offset.x));
  offset.y=Math.max(-80,Math.min(80,offset.y));
  redraw();
}
document.onmouseup=()=>clearInterval(interval);

/* ---------- Objective buttons ---------- */
const objDiv=document.getElementById("objectives");
[4,10,40,60].forEach(o=>{
  const b=document.createElement("button");
  b.textContent=o+"×";
  b.onclick=()=>{
    objective=o;
    redraw();
    [...objDiv.children].forEach(x=>x.classList.remove("active"));
    b.classList.add("active");
  };
  if(o===objective) b.classList.add("active");
  objDiv.appendChild(b);
});

/* ---------- Checking ---------- */
function checkAnswers(){
  const f12=document.getElementById("f12");
  const f3456=document.getElementById("f3456");
  f12.innerHTML=f3456.innerHTML="";
  const suUm=10;

  if(+q1.value!==1000) f12.innerHTML+="<div class='wrong'>100 su ≠ 1000 µm</div>";
  if(+q2.value!==10) f12.innerHTML+="<div class='wrong'>1 su ≠ 10 µm</div>";
  if(f12.innerHTML==="") f12.innerHTML="<div class='correct'>✔ Correct</div>";

  const eu=+q3.value, su=+q4.value;
  if(q5.value!=su*suUm) f3456.innerHTML+="<div class='wrong'>su → µm error</div>";
  if(q6.value!=(su*suUm/eu)) f3456.innerHTML+="<div class='wrong'>eu calibration incorrect</div>";
  if(f3456.innerHTML==="") f3456.innerHTML="<div class='correct'>✔ Correct</div>";
}

/* ---------- Init ---------- */
redraw();
</script>

</body>
</html>
